<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" ><![endif]-->
<!DOCTYPE html>
<html>
<head>
<title>Store-Large-Item-in-DynamoDB</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;page&quot;:3,&quot;toolbar&quot;:&quot;pages zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;Electron\&quot; modified=\&quot;2024-05-04T19:17:44.419Z\&quot; agent=\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/23.1.5 Chrome/120.0.6099.109 Electron/28.1.0 Safari/537.36\&quot; etag=\&quot;i6Fv9nrw6kcKMyaaMxjQ\&quot; version=\&quot;23.1.5\&quot; type=\&quot;device\&quot; pages=\&quot;4\&quot;&gt;\n  &lt;diagram id=\&quot;G7O2jqpdABzEi2VrVt_c\&quot; name=\&quot;README\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1012\&quot; dy=\&quot;659\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;850\&quot; pageHeight=\&quot;1100\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;v1V7xNmCQ-73sL3d13Yb-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;README&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;当你要将大量数据作为一个 attribute 存到 DynamoDB 中时, 由于 DynamoDB 有一个 Item 最大 400KB 的限制, 所以官方推荐你将数据写入到 S3 中, 然后将 S3 URI 存到 DynamoDB 中. 这种方法听起来简单, 但是在生产实践中有很多细节问题值得商榷. 例如:&amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt;&amp;lt;ul&amp;gt;&amp;lt;li&amp;gt;写入到 DynamoDB 和 S3 的操作如果有一个失败了怎么处理?&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;如果 DynamoDB 有多个属性都是这种情况, 这必然导致写入 S3 的耗时会比较长, 如何保证它们全部成功或者全部失败?&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;写入到 S3 的时候应该怎么构建 S3 URI?&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;在 Update 的时候是否要删除旧的 S3 Object? 长期下来产生的很多没有用的 S3 Object 怎么清理?&amp;lt;/li&amp;gt;&amp;lt;/ul&amp;gt;&amp;lt;div&amp;gt;本文将详细的讨论这种将数据写入到 S3, 将 S3 URI 存到 DynamoDB 中的正确做法.&amp;lt;/div&amp;gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=default;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;80\&quot; width=\&quot;680\&quot; height=\&quot;200\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n  &lt;diagram name=\&quot;consistency\&quot; id=\&quot;SBzAipigt8cfWBWiVu9c\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1012\&quot; dy=\&quot;659\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;850\&quot; pageHeight=\&quot;1100\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;Consistency&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;当你要把很大的 Binary 数据存到 DynamoDB 时, 官方推荐是将数据存在 S3, 然后在 DynamoDB 中只保存 S3 uri. 但是这就存在双写一致性问题. AWS 官方文档&amp;amp;nbsp;&amp;lt;a href=&amp;quot;https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-use-s3-too.html&amp;quot;&amp;gt;Best practices for storing large items and attributes&amp;lt;/a&amp;gt;&amp;amp;nbsp;明确说了 AWS 无法保证 DynamoDB 和 S3 的双写一致性. 所以本文重点讨论如何解决这一问题.&amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;首先我们要讨论的是写 DynamoDB 和 写 S3 操作谁先谁后? 可不可以同时进行?&amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;我认为第一可以排除掉同时写的可能性. 首先因为写 S3 的延迟肯定要远远大于写 DynamoDB, 并行执行的意义不大. 其次因为在 Update 的时候, 除了这些 Binary 的 attribute, 可能还有其他 attribute 需要 Update. 例如 update_at 可以用来反映 DynamoDB item 的修改时间. 逻辑上这个 update_at 必须在 S3 写操作全部完成之后才能写入到 DynamoDB.&amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;然后我们讨论两个写操作谁先谁后. 请看下面的分析.&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=default;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;80\&quot; width=\&quot;680\&quot; height=\&quot;240\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-12\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-3\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-5\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-3\&quot; value=\&quot;成功 / 失败?\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.decision;whiteSpace=wrap;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;600\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-4\&quot; value=\&quot;先写 DynamoDB\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;absoluteArcSize=1;arcSize=14;strokeWidth=2;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;480\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-5\&quot; value=\&quot;再写 S3\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;absoluteArcSize=1;arcSize=14;strokeWidth=2;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;720\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-14\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;entryPerimeter=0;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-6\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-8\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;mxPoint x=\&quot;140\&quot; y=\&quot;960\&quot; as=\&quot;targetPoint\&quot; /&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-18\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeColor=#b85450;strokeWidth=2;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#f8cecc;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-6\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-16\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-6\&quot; value=\&quot;成功 / 失败?\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.decision;whiteSpace=wrap;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;840\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-8\&quot; value=\&quot;END\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.terminator;whiteSpace=wrap;fillColor=#f8cecc;strokeColor=#b85450;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;100\&quot; y=\&quot;1080\&quot; width=\&quot;80\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-20\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeColor=default;strokeWidth=2;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-9\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-4\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-9\&quot; value=\&quot;START\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.terminator;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;100\&quot; y=\&quot;400\&quot; width=\&quot;80\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-10\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-4\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-3\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-11\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;fillColor=#f8cecc;strokeColor=#b85450;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-3\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-8\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;480\&quot; y=\&quot;640\&quot; /&gt;\n              &lt;mxPoint x=\&quot;480\&quot; y=\&quot;1100\&quot; /&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-13\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-5\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-6\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-16\&quot; value=\&quot;删除 / 更新 DynamoDB\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;absoluteArcSize=1;arcSize=14;strokeWidth=2;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;280\&quot; y=\&quot;920\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-19\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#b85450;strokeWidth=2;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#f8cecc;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-16\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-8\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-21\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-22\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-24\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-22\&quot; value=\&quot;成功 / 失败?\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.decision;whiteSpace=wrap;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;1400\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-23\&quot; value=\&quot;先写 S3\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;absoluteArcSize=1;arcSize=14;strokeWidth=2;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;1280\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-24\&quot; value=\&quot;再写 DynamoDB\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;absoluteArcSize=1;arcSize=14;strokeWidth=2;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;1520\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-25\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=2;entryPerimeter=0;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-27\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-28\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;mxPoint x=\&quot;140\&quot; y=\&quot;1760\&quot; as=\&quot;targetPoint\&quot; /&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-27\&quot; value=\&quot;成功 / 失败?\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.decision;whiteSpace=wrap;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;1640\&quot; width=\&quot;120\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-28\&quot; value=\&quot;END\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.terminator;whiteSpace=wrap;fillColor=#f8cecc;strokeColor=#b85450;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;100\&quot; y=\&quot;1880\&quot; width=\&quot;80\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-29\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;exitPerimeter=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeColor=default;strokeWidth=2;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-30\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-23\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-30\&quot; value=\&quot;START\&quot; style=\&quot;strokeWidth=2;html=1;shape=mxgraph.flowchart.terminator;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;100\&quot; y=\&quot;1200\&quot; width=\&quot;80\&quot; height=\&quot;40\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-31\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-23\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-22\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-32\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;fillColor=#f8cecc;strokeColor=#b85450;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-22\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-28\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;440\&quot; y=\&quot;1440\&quot; /&gt;\n              &lt;mxPoint x=\&quot;440\&quot; y=\&quot;1900\&quot; /&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;-iAJfEY-i9wxDD9hsPfD-33\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;entryPerimeter=0;strokeWidth=2;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-24\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-27\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;PLTuGtsQSk9eAzh5gjb9-1\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;strokeColor=#b85450;strokeWidth=2;align=center;verticalAlign=middle;fontFamily=Helvetica;fontSize=11;fontColor=default;labelBackgroundColor=default;endArrow=classic;fillColor=#f8cecc;\&quot; parent=\&quot;1\&quot; source=\&quot;-iAJfEY-i9wxDD9hsPfD-27\&quot; target=\&quot;-iAJfEY-i9wxDD9hsPfD-28\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;320\&quot; y=\&quot;1680\&quot; /&gt;\n              &lt;mxPoint x=\&quot;320\&quot; y=\&quot;1900\&quot; /&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;PLTuGtsQSk9eAzh5gjb9-2\&quot; value=\&quot;&amp;lt;h1&amp;gt;先写 S3, 再写 DynamoDB&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;这种方式更好. 因为写 S3 的时候可以新建一个 Object, 如果后续写 DynamoDB 的时候出错, 你可以什么都不做, 并且对数据一致性不会有任何影响. 如果写入 S3 失败了就直接失败既可.&amp;amp;nbsp;&amp;lt;/p&amp;gt;你可能需要 catch exception 然后删除掉无用数据, 取决于你是否需要立刻删掉无用数据. 有些项目需要保留历史记录, 有些项目可以过一段时间之后再批量删除无用数据.\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=#82b366;fillColor=#d5e8d4;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;240\&quot; y=\&quot;1200\&quot; width=\&quot;520\&quot; height=\&quot;200\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;jNxu8FSgCU7Bmh4b0KMn-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;先写 DynamoDB, 再写 S3&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;这样做不是很好. 因为你写入 DynamoDB 成功后写 S3 的过程可能会失败, 并且这个过程可能会比较长. 在这个期间如果有人来读数据就可能会读到脏数据. 并且如果写 S3 失败, 你需要把 DynamoDB 的数据回滚到之前的状态, 比较复杂且容易出错.&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=#b85450;fillColor=#f8cecc;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;240\&quot; y=\&quot;400\&quot; width=\&quot;520\&quot; height=\&quot;200\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;xcvMTxgEYM_X0KDs7Nud-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;先删 S3, 再删 DynamoDB&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;删除的时候稍微有点特殊. 一般先删 DynamoDB 再删 S3. 因为如果你先删 S3 然后删 DynamoDB 失败了, 如果有一个读请求进来就会发现找不到 S3 中的数据, 造成逻辑混乱. 而先删 DynamoDB, 即使删 S3 失败也不要紧, 因为 S3 数据已经用不到了, 以后在批量清除的程序中删除既可.&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=#82b366;fillColor=#d5e8d4;\&quot; vertex=\&quot;1\&quot; parent=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;240\&quot; y=\&quot;2000\&quot; width=\&quot;520\&quot; height=\&quot;200\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;fjpDu2aaolbvOn1VbCHZ-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;Conclusion&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;&amp;lt;span style=&amp;quot;background-color: initial;&amp;quot;&amp;gt;Create / Update 时先写 S3, 再写 DynamoDB, Delete 时先删 DynamoDB 再删 S3&amp;lt;/span&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=default;\&quot; vertex=\&quot;1\&quot; parent=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;2280\&quot; width=\&quot;680\&quot; height=\&quot;80\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n  &lt;diagram id=\&quot;arKxyi4THcbwm6tvvbHB\&quot; name=\&quot;s3-location\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1012\&quot; dy=\&quot;659\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;850\&quot; pageHeight=\&quot;1100\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;Q0NRr7hiTEXVWHYvXIGA-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;S3 Location&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;把 本应存在 DynamoDB 的数据存到 S3 上的时候选择 S3 location 的策略很多. 常见的有以下几种:&amp;lt;/p&amp;gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt;&amp;lt;ol&amp;gt;&amp;lt;li&amp;gt;&amp;lt;b&amp;gt;基于内容&amp;lt;/b&amp;gt;: s3 key 基于内容的 hash. 有利于去除重复避免覆写. 这样做的好处是不存在覆盖掉有用数据的情况. 坏处是删除 S3 上的数据的时候需要检测 object 是否被 DynamoDB 所引用, 这样比较复杂.&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;&amp;lt;b&amp;gt;基于 pk, sk&amp;lt;/b&amp;gt;: 由于 pk, sk 两着合起来是唯一的, 所以用它们合起来做 s3 key 也是一个不错的选择. 但是要注意你 pk, sk compond key 不能作为最终的 key, 因为这样可能会在双写存在失败的时候覆盖掉正确的数据. 这个 compond key 应该作为一个 prefix 存在.&amp;lt;/li&amp;gt;&amp;lt;/ol&amp;gt;&amp;lt;div&amp;gt;这些策略没有哪个最好, 需要根据具体情况选择.&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;除此之外, 还会存在一些需要慎重决定的问题:&amp;lt;/div&amp;gt;&amp;lt;div&amp;gt;&amp;lt;ol&amp;gt;&amp;lt;li&amp;gt;由于存在双写一致性问题, 你在写入 S3 的时候不应该覆盖之前的 S3 object, 因为后续操作可能会失败, 可能会造成你的 DynamoDB 没有更新但是原数据丢失了的情况. 所以如果你使用的是 #2, 那么需要对写入策略进行一定的优化.&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;当 binary 数据发生变化时, 是否需要删除原来的数据也是一个需要考量的因素.&amp;lt;/li&amp;gt;&amp;lt;/ol&amp;gt;&amp;lt;div&amp;gt;&amp;lt;br&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;p&amp;gt;&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=default;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;80\&quot; width=\&quot;680\&quot; height=\&quot;360\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n  &lt;diagram id=\&quot;ItHKOUdhmgLtOgryVzCq\&quot; name=\&quot;cleanup\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1012\&quot; dy=\&quot;659\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;850\&quot; pageHeight=\&quot;1100\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;Vb-7I96BU-UjCANAiuKj-1\&quot; value=\&quot;&amp;lt;h1&amp;gt;Cleanup&amp;lt;/h1&amp;gt;&amp;lt;p&amp;gt;每个 S3 object 都有一个 update at 的 metadata, 这和 DynamoDB item 的时间一致. 所以我们可以用 DynamoDB export 到 S3 (该操作比较便宜, 并不消耗 RCU, 它是用 bin log 实现的. 请看这篇 &amp;lt;a href=&amp;quot;https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/S3DataExport.HowItWorks.html&amp;quot;&amp;gt;DynamoDB data export to Amazon S3: how it works&amp;lt;/a&amp;gt; 官方文档), 然后用一个 batch 程序去对比 DynamoDB 和 S3 既可. 由于 S3 update 的时间可能比真实的 DynamoDB update 时间要早一点 (取决于写入 S3 的耗时), 所以我们可以把时间回溯个 1 小时, 只对比在这之前的数据既可.&amp;lt;br&amp;gt;&amp;lt;/p&amp;gt;\&quot; style=\&quot;text;html=1;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;strokeColor=default;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;80\&quot; y=\&quot;80\&quot; width=\&quot;680\&quot; height=\&quot;120\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n&lt;/mxfile&gt;\n&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>